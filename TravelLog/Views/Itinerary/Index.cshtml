
@{
    ViewData["Title"] = "Index";
    // Layout = "~/Views/Shared/_Layout.cshtml";
}

<h1>Index</h1>

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>行程規劃</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>

<body style="margin: 0;">
    <div style="display:flex;">
        <div id="map" style="width: 50%;height: 100vh;"></div>
        <div style="padding: 16px; width: 50%;">
            <input id="search-input" class="form-control">
            <button class="btn btn-primary mt-2" id="add">加入行程</button>
            <h4 class="mt-4">今日行程</h4>
            <ul class="list-group list-group-flush" id="itinerary-list"></ul>
            <button class="btn btn-success mt-4" id="draw-route">規劃路線</button>
            <h4 class="mt-4">我的行程</h4>
            <button class="btn btn-primary mt-2" id="add_2">儲存行程</button>
            <ul class="list-group list-group-flush" id="list"></ul>


        </div>
    </div>

    <script>
        let map;
        let currentPosition;
        let selectRestaurant;
        let markers = [];
        let directionsService;
        let directionsRenderers = [];
        let itinerary = JSON.parse(localStorage.getItem('itinerary')) || [];

        // 初始化地圖
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 23.553118, lng: 121.0211024 },
                zoom: 7,
            });

            navigator.geolocation.getCurrentPosition(function (position) {
                currentPosition = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude,
                };
                map.setCenter(currentPosition);
                map.setZoom(16);

                // 初始化 Autocomplete
                const autocomplete = new google.maps.places.Autocomplete(document.getElementById('search-input'), {
                    type: ['restaurant'],
                });

                autocomplete.addListener('place_changed', function () {
                    const place = autocomplete.getPlace();
                    selectRestaurant = {
                        location: place.geometry.location,
                        placeId: place.place_id,
                        name: place.name,
                        address: place.formatted_address,
                    };

                    const marker = new google.maps.Marker({
                        position: selectRestaurant.location,
                        map: map,
                    });
                    markers.push(marker);
                    map.setCenter(selectRestaurant.location);
                });

                renderItinerary();
            });
        }

        // 顯示行程列表
        function renderItinerary() {
            const listElement = document.getElementById('itinerary-list');
            listElement.innerHTML = '';

            itinerary.forEach((place, index) => {
                listElement.innerHTML += `
                    <li class="list-group-item d-flex justify-content-between align-items-center" data-index="${index}">
                        <span>${place.name}</span>
                        <button class="btn-close remove"></button>
                    </li>
                `;

                // 在行程項目之間加入路程時間和距離的欄位
                if (index < itinerary.length - 1) {
                    listElement.innerHTML += `
                        <li class="list-group-item text-center text-muted route-info" id="route-info-${index}">
                            計算中...
                        </li>
                    `;
                }
            });
        }

        // 新增行程
        document.getElementById('add').addEventListener('click', function () {
            if (selectRestaurant) {
                itinerary.push(selectRestaurant);
                localStorage.setItem('itinerary', JSON.stringify(itinerary));
                renderItinerary();
                document.getElementById('search-input').value = '';//清空搜尋欄位

            }
        });

        // 移除行程
        document.getElementById('itinerary-list').addEventListener('click', function (e) {
            if (e.target.classList.contains('remove')) {
                const index = Array.from(e.target.parentNode.parentNode.children).indexOf(e.target.parentNode);
                itinerary.splice(index, 1);
                localStorage.setItem('itinerary', JSON.stringify(itinerary));
                markers[index]?.setMap(null);
                markers.splice(index, 1);
                renderItinerary();
            }
        });

        // 規劃路線
        document.getElementById('draw-route').addEventListener('click', function () {
            if (!directionsService) directionsService = new google.maps.DirectionsService();

            directionsRenderers.forEach(renderer => renderer.setMap(null)); // 清除舊的路線
            directionsRenderers = [];

            const colors = ['#FF0000', '#0000FF', '#00FF00', '#FFA500', '#800080']; // 路線顏色清單

            for (let i = 0; i < itinerary.length - 1; i++) {
                const origin = itinerary[i].location;
                const destination = itinerary[i + 1].location;

                const renderer = new google.maps.DirectionsRenderer({
                    map: map,
                    suppressMarkers: true,
                    polylineOptions: {
                        strokeColor: colors[i % colors.length], // 循環使用顏色清單
                        strokeWeight: 6,
                    },
                });
                directionsRenderers.push(renderer);

                directionsService.route({
                    origin: origin,
                    destination: destination,
                    travelMode: "DRIVING", // 預設開車模式
                }, function (response, status) {
                    if (status === "OK") {
                        renderer.setDirections(response);

                        // 顯示路程距離與時間
                        const leg = response.routes[0].legs[0];
                        document.getElementById(`route-info-${i}`).textContent =
                            `距離: ${leg.distance.text}, 預估時間: ${leg.duration.text}`;
                    } else {
                        alert("無法規劃路線：" + status);
                    }
                });
            }

            markers.forEach(marker => marker.setMap(null)); // 清除舊的地標
            itinerary.forEach((place, index) => {
                const marker = new google.maps.Marker({
                    position: place.location,
                    label: `${index + 1}`,
                    map: map,
                });
                markers.push(marker);
            });
        });

        // 啟用拖放功能
        new Sortable(document.getElementById('itinerary-list'), {
            animation: 150,
            onEnd: function (event) {
                const oldIndex = event.oldIndex;
                const newIndex = event.newIndex;
                const movedItem = itinerary.splice(oldIndex, 1)[0];
                itinerary.splice(newIndex, 0, movedItem);
                localStorage.setItem('itinerary', JSON.stringify(itinerary));
                renderItinerary();
            },
        });

        renderItinerary();
    </script>

    <!-- Google Maps API -->
    <script async
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA0mSwZn2Mgu42RjWRxivjrSC3s84nINa0&libraries=places&callback=initMap&region=TW&language=zh-TW"></script>
</body>

</html>